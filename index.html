<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgendaKeepers</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111a36">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AgendaKeepers"> 
    <link rel="apple-touch-icon" href="ESCUDO ATM.png">

    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="ESCUDO ATM.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div class="ios-header-container">
        <div class="header-top-row">
            <div class="brand-box">
                <img src="ESCUDO ATM.png" alt="Escudo" class="escudo-header">
                <div class="brand-text">
                    <h1 class="app-title">AgendaKeepers</h1>
                    <div class="date-info">
                        <h2 id="currentMonthLabel">CARGANDO...</h2>
                        <span class="badge-week" id="currentWeekLabel">...</span>
                    </div>
                </div>
            </div>
            <div class="right-controls">
                <button class="theme-toggle" onclick="openSettings()" style="margin-right: 8px;">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
        </div>

        <div class="nav-row">
            <div class="nav-arrows">
                <button class="nav-btn" onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
                <button class="nav-btn" onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="view-switcher">
                <div id="btnWeek" class="switch-item active" onclick="switchView('week')">Semana</div>
                <div id="btnMonth" class="switch-item" onclick="switchView('month')">Mes</div>
            </div>
        </div>
        
        <div id="datesContainer" class="ios-date-strip"></div>
    </div>

    <main class="agenda-feed"></main>

    <div class="floating-nav">
        <button id="addBtn" class="active">+</button>
    </div>

    <div id="settingsModal" class="ios-modal-overlay">
        <div class="ios-sheet" style="height: auto; max-height: 80vh;">
            <div class="sheet-header">
                <div class="sheet-handle"></div>
                <div class="sheet-controls">
                    <span class="sheet-title">Configuraci√≥n</span>
                    <button class="btn-text save" onclick="closeSettings()">Cerrar</button>
                </div>
            </div>
            <div class="sheet-body">
                
                <div class="settings-card" onclick="duplicateLastWeek()">
                    <div class="settings-icon"><i class="fas fa-copy"></i></div>
                    <div class="settings-info">
                        <h3>Duplicar Semana Anterior</h3>
                        <p>Copia la estructura de la semana pasada a esta.</p>
                    </div>
                    <div class="settings-arrow"><i class="fas fa-chevron-right"></i></div>
                </div>

                <div class="settings-group-label">COPIA DE SEGURIDAD</div>
                
                <div class="settings-row">
                    <button class="btn-settings-action" onclick="exportData()">
                        <i class="fas fa-cloud-download-alt"></i> Exportar Datos
                    </button>
                    <button class="btn-settings-action secondary" onclick="document.getElementById('importFile').click()">
                        <i class="fas fa-cloud-upload-alt"></i> Importar Datos
                    </button>
                    <input type="file" id="importFile" style="display:none" onchange="importData(this)">
                </div>

                <div style="height: 50px;"></div>
            </div>
        </div>
    </div>

    <div id="newSessionModal" class="ios-modal-overlay">
        <div class="ios-sheet">
            <div class="sheet-header">
                <div class="sheet-handle"></div>
                <div class="sheet-controls">
                    <button class="btn-text cancel" onclick="closeModal()">Cancelar</button>
                    <span class="sheet-title" id="modalTitle">Nueva Actividad</span>
                    <button class="btn-text save" onclick="saveSession()">Guardar</button>
                </div>
            </div>

            <div class="sheet-body">
                <label class="input-label">TIPO DE ACTIVIDAD</label>
                <div class="segment-control-scroll">
                    <div class="segment-option active" data-val="training" onclick="selectType(this)">‚öΩÔ∏è Entreno</div>
                    <div class="segment-option" data-val="match" onclick="selectType(this)"><i class="fas fa-landmark"></i> Partido</div>
                    <div class="segment-option" data-val="tournament" onclick="selectType(this)">üèÜ Torneo</div>
                    <div class="segment-option" data-val="gym" onclick="selectType(this)">üí™ Gym</div>
                    <div class="segment-option" data-val="meeting" onclick="selectType(this)">ü§ù Reuni√≥n</div>
                </div>

                <div id="matchConfig" style="display:none; margin-bottom: 15px; background: rgba(128,128,128,0.1); padding: 15px; border-radius: 12px; border: 1px solid var(--input-border);">
                    <label class="input-label" style="color: var(--atm-red);">DATOS DEL ENCUENTRO</label>
                    <div class="row">
                        <div style="width: 40%;">
                            <label class="input-label">COMPETICI√ìN</label>
                            <select id="inputComp" class="ios-input" style="padding: 14px;">
                                <option value="LIGA">LIGA</option>
                                <option value="TORNEO">TORNEO</option>
                                <option value="AMISTOSO">AMISTOSO</option>
                                <option value="COPA">COPA</option>
                            </select>
                        </div>
                        <div style="width: 60%;">
                            <label class="input-label">RIVAL</label>
                            <input type="text" id="inputRival" placeholder="Ej. Real Madrid" class="ios-input">
                        </div>
                    </div>
                </div>

                <div id="tourConfig" style="display:none; margin-bottom: 15px; background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(243, 156, 18, 0.3);">
                    <label class="input-label" style="color: #f39c12;">DURACI√ìN</label>
                    <div class="row">
                        <div class="full-width">
                            <label class="input-label">DESDE</label>
                            <input type="date" id="tourStart" class="ios-input">
                        </div>
                        <div class="full-width">
                            <label class="input-label">HASTA</label>
                            <input type="date" id="tourEnd" class="ios-input">
                        </div>
                    </div>
                </div>

                <div id="titleRow">
                    <label class="input-label" id="labelTitle">T√çTULO SESI√ìN</label>
                    <input type="text" id="inputTitle" placeholder="Ej. Velocidad de Reacci√≥n" class="ios-input">
                </div>

                <div id="locationRow" class="row">
                    <div class="full-width">
                        <input type="text" id="inputSub" placeholder="Ubicaci√≥n (Campo/Estadio)" class="ios-input">
                    </div>
                    <div class="full-width">
                        <input type="text" id="inputTeam" placeholder="Equipo (Juv A)" class="ios-input">
                    </div>
                </div>

                <div id="meetingConfig" style="display:none; margin-bottom:15px;">
                    <div class="row">
                        <button class="btn-toggle active" id="btnPresencial" onclick="toggleMeetingMode('presencial')">Presencial</button>
                        <button class="btn-toggle" id="btnOnline" onclick="toggleMeetingMode('online')">Online</button>
                    </div>
                    <input type="text" id="inputLink" placeholder="Enlace videollamada" class="ios-input" style="display:none; margin-top:10px;">
                </div>

                <div id="weatherSection">
                    <label class="input-label">CLIMATOLOG√çA</label>
                    <div class="weather-selector">
                        <div class="weather-option selected" onclick="selectWeather(this, 'sun')" data-w="sun"><i class="fas fa-sun"></i></div>
                        <div class="weather-option" onclick="selectWeather(this, 'cloud')" data-w="cloud"><i class="fas fa-cloud"></i></div>
                        <div class="weather-option" onclick="selectWeather(this, 'rain')" data-w="rain"><i class="fas fa-cloud-showers-heavy"></i></div>
                        <div class="weather-option" onclick="selectWeather(this, 'snow')" data-w="snow"><i class="fas fa-snowflake"></i></div>
                        <div class="weather-option" onclick="selectWeather(this, 'wind')" data-w="wind"><i class="fas fa-wind"></i></div>
                    </div>
                </div>

                <div class="row" id="timeRow">
                    <div class="full-width">
                        <label class="input-label">INICIO</label>
                        <input type="time" id="inputStart" value="10:00" class="ios-input">
                    </div>
                    <div class="full-width">
                        <label class="input-label">FIN</label>
                        <input type="time" id="inputEnd" value="11:30" class="ios-input">
                    </div>
                </div>

                <label class="input-label">DOCUMENTACI√ìN (PDF/IMG)</label>
                <div class="file-upload-box">
                    <input type="file" id="inputFile" accept="application/pdf, image/*" onchange="handleFileSelect(this)">
                    <div class="file-placeholder">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span id="fileNameDisplay">Subir Archivo</span>
                    </div>
                </div>

                <div id="colorSection">
                    <label class="input-label">ENFOQUE</label>
                    <div class="color-picker-row">
                        <div class="color-dot selected" style="background: var(--col-of);" data-class="btn-of" onclick="selectColor(this)"></div>
                        <div class="color-dot" style="background: var(--col-def);" data-class="btn-def" onclick="selectColor(this)"></div>
                        <div class="color-dot" style="background: var(--col-tac);" data-class="btn-tac" onclick="selectColor(this)"></div>
                        <div class="color-dot" style="background: var(--col-rein);" data-class="btn-rein" onclick="selectColor(this)"></div>
                    </div>
                </div>
                <div style="height: 100px;"></div>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
        }

        // UTILIDADES
        function getKeyFromDate(date) { 
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // ESTADO
        let currentDate = new Date();
        let viewMode = 'week';
        let eventsDB = {}; 
        let editingId = null;
        let tempFileBase64 = null;
        let tempType = 'training';
        let tempColor = 'btn-of';
        let tempWeather = 'sun';
        let meetingMode = 'presencial';

        // CARGA
        function loadState() {
            const storedEvents = localStorage.getItem('agenda_events');
            if (storedEvents) eventsDB = JSON.parse(storedEvents);
            
            const storedTheme = localStorage.getItem('agenda_theme');
            if (storedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            }
            const storedView = localStorage.getItem('agenda_view');
            if (storedView) viewMode = storedView;
            
            document.getElementById('btnWeek').classList.toggle('active', viewMode === 'week');
            document.getElementById('btnMonth').classList.toggle('active', viewMode === 'month');
        }

        function saveState() {
            localStorage.setItem('agenda_events', JSON.stringify(eventsDB));
            localStorage.setItem('agenda_theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
            localStorage.setItem('agenda_view', viewMode);
        }

        // AJUSTES
        function openSettings() { document.getElementById('settingsModal').classList.add('open'); }
        function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }
        
        function exportData() {
            const dataStr = JSON.stringify(localStorage);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'AgendaKeepers_Backup.json';
            let linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                    alert('Datos restaurados. Recargando...');
                    location.reload();
                } catch(err) { alert('Error al leer el archivo.'); }
            };
            reader.readAsText(file);
        }

        function duplicateLastWeek() {
            if(!confirm("¬øCopiar estructura de la semana pasada?")) return;
            const currentWeekStart = getStartOfWeek(new Date(currentDate));
            const prevWeekStart = new Date(currentWeekStart);
            prevWeekStart.setDate(prevWeekStart.getDate() - 7);

            for (let i = 0; i < 7; i++) {
                let srcDate = new Date(prevWeekStart);
                srcDate.setDate(prevWeekStart.getDate() + i);
                let srcKey = getKeyFromDate(srcDate);
                
                let destDate = new Date(currentWeekStart);
                destDate.setDate(currentWeekStart.getDate() + i);
                let destKey = getKeyFromDate(destDate);

                if (eventsDB[srcKey]) {
                    if (!eventsDB[destKey]) eventsDB[destKey] = [];
                    eventsDB[srcKey].forEach(ev => {
                        let newEv = JSON.parse(JSON.stringify(ev));
                        newEv.id = Date.now() + Math.random();
                        eventsDB[destKey].push(newEv);
                    });
                }
            }
            saveState();
            closeSettings();
            renderEventsList();
            renderDates();
            alert("Semana duplicada.");
        }

        // RENDER
        function updateHeader() {
            const monthNames = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
            document.getElementById('currentMonthLabel').innerText = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            const onejan = new Date(currentDate.getFullYear(), 0, 1);
            const weekNum = Math.ceil((((currentDate - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            document.getElementById('currentWeekLabel').innerText = `SEMANA ${weekNum}`;
        }

        function renderDates() {
            const container = document.getElementById('datesContainer');
            container.innerHTML = '';
            
            if (viewMode === 'week') {
                let startDay = getStartOfWeek(new Date(currentDate));
                for (let i = 0; i < 7; i++) {
                    let d = new Date(startDay);
                    d.setDate(startDay.getDate() + i);
                    renderDateItem(d, container);
                }
                container.style.justifyContent = 'center';
            } else {
                let year = currentDate.getFullYear();
                let month = currentDate.getMonth();
                let daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 1; i <= daysInMonth; i++) {
                    renderDateItem(new Date(year, month, i), container);
                }
                container.style.justifyContent = 'flex-start';
            }
        }

        function renderDateItem(date, container) {
            const daysNames = ['DOM','LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB'];
            let dayKey = getKeyFromDate(date);
            let isSelected = dayKey === getKeyFromDate(currentDate);
            let hasEvents = eventsDB[dayKey] && eventsDB[dayKey].length > 0;
            
            let div = document.createElement('div');
            div.className = `date-item ${isSelected ? 'active' : ''}`;
            div.onclick = function() { selectDate(date); };
            div.innerHTML = `<span class="day-name">${daysNames[date.getDay()]}</span><span class="day-num">${date.getDate()}</span>${hasEvents ? '<div class="dot-indicator"></div>' : ''}`;
            container.appendChild(div);
            if(isSelected && viewMode === 'month') setTimeout(() => div.scrollIntoView({behavior: 'smooth', inline: 'center', block: 'nearest'}), 100);
        }

        function renderEventsList() {
            const container = document.querySelector('.agenda-feed');
            const key = getKeyFromDate(currentDate);
            const events = eventsDB[key] || [];
            container.innerHTML = '';
            container.classList.add('loading');
            setTimeout(() => {
                container.classList.remove('loading');
                if (events.length === 0) {
                    container.innerHTML = `<div class="empty-state"><span class="empty-icon">üìÖ</span><h3>Sin Actividad</h3><p>No hay eventos programados.</p></div>`;
                } else {
                    events.forEach(ev => container.innerHTML += createCardHTML(ev));
                }
            }, 50);
        }

        function createCardHTML(event) {
            const isMatch = event.type === 'match';
            const isTournament = event.type === 'tournament';
            
            let displayTitle = event.title;
            let displaySub = event.subtitle || 'Ciudad Deportiva';
            let badgeHTML = '';
            let cardStyle = '';
            let titleStyle = '';
            let subStyle = ''; 
            
            const weatherIcons = {
                'sun': '<i class="fas fa-sun" style="color:#f1c40f"></i>',
                'cloud': '<i class="fas fa-cloud" style="color:#bdc3c7"></i>',
                'rain': '<i class="fas fa-cloud-showers-heavy" style="color:#3498db"></i>',
                'snow': '<i class="fas fa-snowflake" style="color:#ecf0f1"></i>',
                'wind': '<i class="fas fa-wind" style="color:#95a5a6"></i>'
            };
            const weatherIcon = event.weather ? weatherIcons[event.weather] : '';

            let timeLeft = `<span class="time-start">${event.timeStart}</span><span class="time-end">${event.timeEnd}</span>`;
            if (isTournament) timeLeft = `<span class="time-start" style="font-size:0.6rem;">D√çA</span><span class="time-end" style="color:#f39c12;">TORNEO</span>`;

            if (isMatch) {
                cardStyle = 'border: 1px solid var(--atm-red); background: linear-gradient(135deg, #1C2C5B, #000);';
                badgeHTML = `<span class="badge" style="background:var(--atm-red); font-size:0.8rem;">${event.competition || 'PARTIDO'}</span>`;
                titleStyle = 'color: #ffffff !important;';
                subStyle = 'color: #cccccc !important;';
                if(event.rival) displayTitle = `<span style="font-weight:400; font-size:0.9rem; color:#aaa;">VS</span> <span style="color:white;">${event.rival.toUpperCase()}</span>`;
            } 
            else if (isTournament) {
                cardStyle = 'border: 1px solid #f39c12; background: linear-gradient(135deg, #583e06, #111);';
                badgeHTML = '<span class="badge" style="background:#f39c12; color:black;">TORNEO</span>';
                titleStyle = 'color: #ffffff !important;';
                subStyle = 'color: #f1c40f !important; font-weight:600;';
            }
            else if (event.type === 'meeting') {
                cardStyle = 'border-left: 4px solid #3498db; background: var(--bg-card);';
                badgeHTML = '<span class="badge" style="background:#3498db">REUNI√ìN</span>';
            } 
            else {
                let c = 'var(--atm-red)';
                if(event.colorClass.includes('of')) c = 'var(--col-of)';
                if(event.colorClass.includes('def')) c = 'var(--col-def)';
                if(event.colorClass.includes('tac')) c = 'var(--col-tac)';
                badgeHTML = `<span class="badge" style="background:${c}">ENTRENO</span>`;
            }

            if (event.team) {
                let teamColor = (isMatch || isTournament) ? '#ffffff' : 'var(--text-main)';
                displaySub += ` ‚Ä¢ <span style="color:${teamColor}; font-weight:600;">${event.team}</span>`;
            }
            if(weatherIcon) displaySub += ` ‚Ä¢ ${weatherIcon}`;

            let btns = '';
            if (event.fileData) btns += `<button class="btn-ios-action primary" onclick="openFile('${event.id}')"><span>üìÑ Ver PDF</span></button>`;
            else btns += `<button class="btn-ios-action primary disabled"><span>üìÑ No PDF</span></button>`;
            
            btns += `<button class="btn-ios-action secondary" onclick="editEvent('${event.id}')"><span>‚úèÔ∏è Editar</span></button>`;

            return `
            <div class="agenda-card">
                <div class="time-col">${timeLeft}<div class="vertical-line"></div></div>
                <div class="card-details modern-card" style="${cardStyle}">
                    <div class="card-header-row"><div>${badgeHTML}</div></div>
                    <h3 class="card-title" style="${titleStyle}">${displayTitle}</h3>
                    <p class="card-subtitle" style="${subStyle}">${displaySub}</p>
                    <div class="card-actions">${btns}</div>
                </div>
            </div>`;
        }

        // INTERACCIONES
        window.selectDate = function(date) { currentDate = date; updateHeader(); renderDates(); renderEventsList(); }
        window.changeDate = function(dir) {
            if (viewMode === 'week') currentDate.setDate(currentDate.getDate() + (dir * 7));
            else currentDate.setMonth(currentDate.getMonth() + dir);
            selectDate(currentDate);
        }
        window.switchView = function(mode) {
            viewMode = mode;
            document.getElementById('btnWeek').classList.toggle('active', mode === 'week');
            document.getElementById('btnMonth').classList.toggle('active', mode === 'month');
            saveState();
            renderDates();
        }
        window.toggleTheme = function() {
            document.body.classList.toggle('light-mode');
            const icon = document.getElementById('themeIcon');
            icon.className = document.body.classList.contains('light-mode') ? 'fas fa-sun' : 'fas fa-moon';
            saveState();
        }

        // FORMULARIO
        const modal = document.getElementById('newSessionModal');
        document.getElementById('addBtn').onclick = () => {
            resetForm();
            modal.classList.add('open');
            const todayStr = getKeyFromDate(currentDate);
            document.getElementById('tourStart').value = todayStr;
            document.getElementById('tourEnd').value = todayStr;
        };
        window.closeModal = () => modal.classList.remove('open');

        // L√ìGICA DE SELECCI√ìN DE TIPO Y PLACEHOLDER
        window.selectType = function(el) {
            document.querySelectorAll('.segment-option').forEach(o => o.classList.remove('active'));
            el.classList.add('active');
            tempType = el.getAttribute('data-val');

            const matchConfig = document.getElementById('matchConfig');
            const tourConfig = document.getElementById('tourConfig');
            const titleRow = document.getElementById('titleRow');
            const meetConfig = document.getElementById('meetingConfig');
            const colorSec = document.getElementById('colorSection');
            const locationRow = document.getElementById('locationRow');
            const timeRow = document.getElementById('timeRow');
            const weatherSec = document.getElementById('weatherSection');
            const inputSub = document.getElementById('inputSub');

            // Reset
            matchConfig.style.display = 'none';
            tourConfig.style.display = 'none';
            titleRow.style.display = 'block';
            meetConfig.style.display = 'none';
            colorSec.style.display = 'block';
            locationRow.style.display = 'flex';
            timeRow.style.display = 'flex';
            weatherSec.style.display = 'block';
            document.getElementById('labelTitle').innerText = "T√çTULO SESI√ìN";
            
            // Default Placeholder
            inputSub.placeholder = "Ubicaci√≥n (Campo/Estadio)";

            if (tempType === 'match') {
                matchConfig.style.display = 'block';
                titleRow.style.display = 'none';
                colorSec.style.display = 'none';
            } else if (tempType === 'meeting') {
                meetConfig.style.display = 'block';
                colorSec.style.display = 'none';
                weatherSec.style.display = 'none';
                toggleMeetingMode('presencial');
            } else if (tempType === 'tournament') {
                tourConfig.style.display = 'block';
                timeRow.style.display = 'none';
                colorSec.style.display = 'none';
                document.getElementById('labelTitle').innerText = "NOMBRE DEL TORNEO";
            }
        }

        window.toggleMeetingMode = function(mode) {
            meetingMode = mode;
            document.getElementById('btnPresencial').classList.toggle('active', mode === 'presencial');
            document.getElementById('btnOnline').classList.toggle('active', mode === 'online');
            const linkInput = document.getElementById('inputLink');
            const locationRow = document.getElementById('locationRow');
            const inputSub = document.getElementById('inputSub');

            if (mode === 'online') {
                linkInput.style.display = 'block';
                locationRow.style.display = 'none';
            } else {
                linkInput.style.display = 'none';
                locationRow.style.display = 'flex';
                inputSub.placeholder = "Sala / Despacho"; // Placeholder espec√≠fico Reuni√≥n Presencial
            }
        }

        window.selectWeather = function(el, type) {
            document.querySelectorAll('.weather-option').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            tempWeather = type;
        }

        window.selectColor = function(el) {
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            tempColor = el.getAttribute('data-class');
        }

        window.handleFileSelect = function(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempFileBase64 = e.target.result;
                    document.getElementById('fileNameDisplay').innerText = "Archivo Listo";
                    document.getElementById('fileNameDisplay').style.color = "#00ff88";
                };
                reader.readAsDataURL(file);
            }
        }

        window.openFile = function(eventId) {
            const key = getKeyFromDate(currentDate);
            const event = eventsDB[key].find(e => e.id == eventId);
            if(event && event.fileData) {
                const win = window.open();
                win.document.write('<iframe src="' + event.fileData + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
            } else alert("Error al abrir archivo");
        }

        window.editEvent = function(id) {
            const key = getKeyFromDate(currentDate);
            const event = eventsDB[key].find(e => e.id == id);
            if (!event) return;

            document.getElementById('inputSub').value = event.subtitle || '';
            document.getElementById('inputTeam').value = event.team || '';
            document.getElementById('inputStart').value = event.timeStart;
            document.getElementById('inputEnd').value = event.timeEnd;
            document.getElementById('inputTitle').value = event.title || '';

            const typeBtn = document.querySelector(`.segment-option[data-val="${event.type}"]`);
            if(typeBtn) selectType(typeBtn);

            if(event.weather) {
                const wBtn = document.querySelector(`.weather-option[data-w="${event.weather}"]`);
                if(wBtn) selectWeather(wBtn, event.weather);
            }

            if(event.type === 'tournament') {
                document.getElementById('tourConfig').style.display = 'none';
                document.getElementById('titleRow').style.display = 'block';
                document.getElementById('labelTitle').innerText = "NOMBRE DEL TORNEO";
                document.getElementById('locationRow').style.display = 'flex';
            }
            if (event.type === 'match') {
                document.getElementById('inputComp').value = event.competition || 'LIGA';
                document.getElementById('inputRival').value = event.rival || '';
            }
            if (event.type === 'meeting') {
                if (event.link) { toggleMeetingMode('online'); document.getElementById('inputLink').value = event.link; }
                else toggleMeetingMode('presencial');
            }

            tempFileBase64 = event.fileData;
            if(tempFileBase64) {
                document.getElementById('fileNameDisplay').innerText = "Archivo Mantenido";
                document.getElementById('fileNameDisplay').style.color = "#00ff88";
            }

            editingId = id;
            document.getElementById('modalTitle').innerText = "Editar Actividad";
            modal.classList.add('open');
        }

        window.saveSession = function() {
            if (tempType !== 'match' && !document.getElementById('inputTitle').value) { alert("Ponle un t√≠tulo"); return; }
            if (tempType === 'match' && !document.getElementById('inputRival').value) { alert("Indica el rival"); return; }

            if (tempType === 'tournament' && !editingId) {
                const startStr = document.getElementById('tourStart').value;
                const endStr = document.getElementById('tourEnd').value;
                if(!startStr || !endStr) { alert("Indica fechas"); return; }
                
                const sParts = startStr.split('-');
                const eParts = endStr.split('-');
                let loopDate = new Date(sParts[0], sParts[1]-1, sParts[2]);
                const endDate = new Date(eParts[0], eParts[1]-1, eParts[2]);
                const sharedId = Date.now();

                while (loopDate <= endDate) {
                    const key = getKeyFromDate(loopDate);
                    if(!eventsDB[key]) eventsDB[key] = [];
                    eventsDB[key].push({
                        id: sharedId + "_" + key,
                        type: 'tournament',
                        title: document.getElementById('inputTitle').value,
                        subtitle: document.getElementById('inputSub').value || 'Ubicaci√≥n Torneo',
                        team: document.getElementById('inputTeam').value || '',
                        timeStart: '', timeEnd: '',
                        colorClass: 'btn-rein',
                        weather: tempWeather,
                        fileData: tempFileBase64
                    });
                    loopDate.setDate(loopDate.getDate() + 1);
                }
                saveState();
                closeModal();
                selectDate(new Date(sParts[0], sParts[1]-1, sParts[2]));
                resetForm();
                return;
            }

            const key = getKeyFromDate(currentDate);
            if(!eventsDB[key]) eventsDB[key] = [];

            let finalSubtitle = document.getElementById('inputSub').value || 'Ciudad Deportiva';
            let finalLink = null;
            if (tempType === 'meeting' && meetingMode === 'online') {
                finalSubtitle = "Online";
                finalLink = document.getElementById('inputLink').value || "#";
            }

            const eventData = {
                type: tempType,
                title: document.getElementById('inputTitle').value,
                subtitle: finalSubtitle,
                link: finalLink,
                team: document.getElementById('inputTeam').value || '',
                timeStart: document.getElementById('inputStart').value,
                timeEnd: document.getElementById('inputEnd').value,
                colorClass: tempColor,
                fileData: tempFileBase64,
                competition: document.getElementById('inputComp').value,
                rival: document.getElementById('inputRival').value,
                weather: tempWeather
            };

            if (editingId) {
                const idx = eventsDB[key].findIndex(e => e.id == editingId);
                if (idx !== -1) {
                    if(eventsDB[key][idx].type === 'tournament') {
                        eventData.type = 'tournament';
                        eventData.colorClass = 'btn-rein'; 
                        eventData.timeStart = ''; eventData.timeEnd = '';
                    }
                    eventsDB[key][idx] = { ...eventData, id: editingId };
                }
            } else {
                eventsDB[key].push({ ...eventData, id: Date.now() });
            }

            eventsDB[key].sort((a,b) => a.timeStart.localeCompare(b.timeStart));
            saveState();
            closeModal();
            renderEventsList();
            renderDates();
            resetForm();
        }

        function resetForm() {
            document.getElementById('inputTitle').value = "";
            document.getElementById('inputSub').value = "";
            document.getElementById('inputTeam').value = "";
            document.getElementById('inputRival').value = "";
            document.getElementById('inputLink').value = "";
            document.getElementById('fileNameDisplay').innerText = "Adjuntar Sesi√≥n";
            document.getElementById('fileNameDisplay').style.color = "inherit";
            document.getElementById('inputFile').value = "";
            tempFileBase64 = null;
            editingId = null;
            tempWeather = 'sun';
            document.querySelectorAll('.weather-option').forEach(d => d.classList.remove('selected'));
            document.querySelector('.weather-option[data-w="sun"]').classList.add('selected');
        }

        loadState();
        updateHeader();
        renderDates();
        renderEventsList();
    </script>
</body>
</html>